rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: get user document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Helper: check if user is platform admin
    function isPlatformAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }

    // Helper: check if user belongs to the customer
    function isCustomerMember(customerId) {
      return isAuthenticated() && getUserData().customerId == customerId;
    }

    // Helper: check if user is admin of the customer
    function isCustomerAdmin(customerId) {
      return isCustomerMember(customerId) && getUserData().role == 'admin';
    }

    // Users collection (global, not customer-scoped)
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isPlatformAdmin());
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || isPlatformAdmin());
      allow delete: if isPlatformAdmin();

      // Watch history subcollection
      match /watchHistory/{contentId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
        allow read, delete: if isPlatformAdmin();
      }

      // Quiz results subcollection
      match /quizResults/{quizId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
        allow read: if isPlatformAdmin();
      }
    }

    // Customers collection
    match /customers/{customerId} {
      allow read: if isCustomerMember(customerId) || isPlatformAdmin();
      allow create: if isPlatformAdmin();
      allow update: if isCustomerAdmin(customerId) || isPlatformAdmin();
      allow delete: if isPlatformAdmin();

      // Customer-scoped classrooms
      match /classrooms/{classroomId} {
        allow read: if isCustomerMember(customerId) || isPlatformAdmin();
        allow create, update, delete: if isCustomerAdmin(customerId) || isPlatformAdmin();
      }

      // Customer-scoped contents
      match /contents/{contentId} {
        allow read: if isCustomerMember(customerId) || isPlatformAdmin();
        allow create, update, delete: if isCustomerAdmin(customerId) || isPlatformAdmin();
      }

      // Customer-scoped quizzes
      match /quizzes/{quizId} {
        allow read: if isCustomerMember(customerId) || isPlatformAdmin();
        allow create, update, delete: if isCustomerAdmin(customerId) || isPlatformAdmin();
      }

      // Customer settings (API keys, etc.)
      match /settings/{settingId} {
        allow read: if isCustomerMember(customerId) || isPlatformAdmin();
        allow write: if isCustomerAdmin(customerId) || isPlatformAdmin();
      }
    }
  }
}
