rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: ensure clients cannot modify subscription fields (only Cloud Functions via Admin SDK)
    function subscriptionFieldsUnchanged() {
      return (!('stripeCustomerId' in request.resource.data) ||
              request.resource.data.stripeCustomerId == resource.data.stripeCustomerId)
        && (!('subscriptionStatus' in request.resource.data) ||
            request.resource.data.subscriptionStatus == resource.data.subscriptionStatus)
        && (!('subscriptionId' in request.resource.data) ||
            request.resource.data.subscriptionId == resource.data.subscriptionId);
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own document
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      // Only the user themselves can create their own document
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Only admins can update user roles, users can update their own profile
      // TODO: Stripe本番接続時は subscriptionFieldsUnchanged() を有効化する
      // 現在はテストモード: ユーザー自身がサブスクフィールドを変更可能
      allow update: if isAuthenticated() && (
        request.auth.uid == userId ||
        isAdmin()
      );
      // Only admins can delete users
      allow delete: if isAdmin();

      // Watch history subcollection - users can read/write their own, admins can read/delete
      match /watchHistory/{contentId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
        allow read, delete: if isAdmin();
      }
    }

    // Classrooms collection
    match /classrooms/{classroomId} {
      // Public classrooms are readable by everyone, draft/other types are admin-only
      allow read: if resource.data.accessType in ['public', 'free'] || isAdmin();
      // Only admins can create/update/delete classrooms
      allow create, update, delete: if isAdmin();
    }

    // Contents collection
    match /contents/{contentId} {
      // Contents are readable if the parent classroom is public, or user is admin
      allow read: if get(/databases/$(database)/documents/classrooms/$(resource.data.classroomId)).data.accessType in ['public', 'free'] || isAdmin();
      // Only admins can manage contents
      allow create, update, delete: if isAdmin();
    }

    // RAG Indexes - 認証済みユーザーは読み取り可能
    match /ragIndexes/{indexId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;

      match /chunks/{chunkId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.token.admin == true;
      }
    }
  }
}
